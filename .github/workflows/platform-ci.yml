name: Platform CI

on:
  workflow_dispatch:
  pull_request:
    paths:
      - 'platform/**'
      - 'clusters/**'
      - 'gitops/**'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup tools
        run: |
          sudo apt-get update
          sudo apt-get install -y yamllint
          curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl
          sudo install kubectl /usr/local/bin/kubectl
          # Install kubeconform for offline validation
          curl -L https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz | tar xz
          sudo mv kubeconform /usr/local/bin/

      # - name: YAML lint
      #   run: |
      #     yamllint -d '{extends: default, rules: {line-length: disable}}' .

      # - name: Kustomize build and validate per environment
      #   run: |
      #     for env in dev stage prod; do
      #       echo "Validating $env environment..."
      #       kubectl kustomize gitops/flux/cluster-config/$env --load-restrictor=LoadRestrictionsNone | \
      #         kubeconform -strict -ignore-missing-schemas -summary -output json -
      #     done

      # - name: Helm template validation with env values
      #   run: |
      #     helm repo add istio https://istio-release.storage.googleapis.com/charts
      #     helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
      #     helm repo add jetstack https://charts.jetstack.io
      #     helm repo add external-dns https://kubernetes-sigs.github.io/external-dns/
      #     helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
      #     helm repo add grafana https://grafana.github.io/helm-charts
      #     helm repo add elastic https://helm.elastic.co
      #     helm repo add fluent https://fluent.github.io/helm-charts
      #     helm repo add jaegertracing https://jaegertracing.github.io/helm-charts
      #     helm repo update
      #     
      #     echo "Validating Helm charts with environment-specific values..."
      #     for env in dev stage prod; do
      #       echo "Validating charts for $env environment..."
      #       
      #       # Validate Istio charts with default values (they share a common values file which doesn't work with helm template)
      #       helm template test-istio-istiod istio/istiod > /dev/null || exit 1
      #       helm template test-istio-gateway istio/gateway > /dev/null || exit 1
      #       
      #       # Validate other charts with env-specific values
      #       helm template test-ingress ingress-nginx/ingress-nginx -f clusters/$env/values/ingress-nginx-values.yaml > /dev/null || exit 1
      #       helm template test-cert-manager jetstack/cert-manager -f clusters/$env/values/cert-manager-values.yaml > /dev/null || exit 1
      #       helm template test-prometheus prometheus-community/kube-prometheus-stack -f clusters/$env/values/prometheus-values.yaml > /dev/null || exit 1
      #       helm template test-grafana grafana/grafana -f clusters/$env/values/grafana-values.yaml > /dev/null || exit 1
      #       helm template test-elasticsearch elastic/elasticsearch -f clusters/$env/values/logging-values.yaml > /dev/null || exit 1
      #       helm template test-kibana elastic/kibana -f clusters/$env/values/logging-values.yaml > /dev/null || exit 1
      #       helm template test-fluent-bit fluent/fluent-bit -f clusters/$env/values/logging-values.yaml > /dev/null || exit 1
      #       
      #       # Optional charts (don't fail on error)
      #       helm template test-external-dns external-dns/external-dns -f clusters/$env/values/external-dns-values.yaml > /dev/null || true
      #       helm template test-jaeger jaegertracing/jaeger -f clusters/$env/values/tracing-values.yaml > /dev/null || true
      #     done
      #     
      #     echo "âœ“ All Helm charts validated successfully"

  deploy-dev:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE }}

      - name: Pull AKS kubeconfig
        run: az aks get-credentials -g hub -n k8s-framework --overwrite-existing


      - name: Install Flux CLI (or Helmfile if you prefer)
        run: curl -s https://fluxcd.io/install.sh | sudo bash

      - name: Bootstrap Flux (first run)
        run: |
          # Install Flux controllers if not present
          flux check --pre || flux install --components-extra=image-reflector-controller,image-automation-controller
          
          # Apply GitRepository
          kubectl apply -f gitops/flux/cluster-config/gitrepository.yaml
          
          # Apply environment Kustomization
          kubectl apply -f gitops/flux/cluster-config/kustomization-dev.yaml

      - name: Reconcile Flux
        run: |
          flux reconcile source git platform-repo --with-source
          flux reconcile kustomization platform-dev --with-source
