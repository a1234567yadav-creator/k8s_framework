# Backstage ConfigMap for app configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: backstage-app-config
  namespace: backstage
data:
  app-config.yaml: |
    app:
      title: K8s Framework Developer Portal
      baseUrl: http://localhost:7007
      
    organization:
      name: K8s Framework Platform
      
    backend:
      baseUrl: http://localhost:7007
      listen:
        port: 7007
        host: 0.0.0.0
      cors:
        origin: http://localhost:7007
        credentials: true
      database:
        client: pg
        connection:
          host: ${POSTGRES_HOST}
          port: ${POSTGRES_PORT}
          user: ${POSTGRES_USER}
          password: ${POSTGRES_PASSWORD}
          database: ${POSTGRES_DB}
    
    # Authentication configuration - allow guest access
    auth:
      providers:
        guest:
          dangerouslyAllowOutsideDevelopment: true
    
    # Required techdocs configuration
    techdocs:
      builder: 'local'
      generator:
        runIn: 'local'
      publisher:
        type: 'local'
    
    # Basic catalog configuration
    catalog:
      rules:
        - allow: [Component, System, API, Resource, Location]
      locations:
        - type: file
          target: /etc/backstage/catalog/platform-catalog.yaml
          
    # Kubernetes integration
    kubernetes:
      serviceLocatorMethod:
        type: 'multiTenant'
      clusterLocatorMethods:
        - type: 'config'
          clusters:
            - url: https://kubernetes.default.svc
              name: k8s-framework
              authProvider: 'serviceAccount'
              skipTLSVerify: true
              skipMetricsLookup: false
    
    # Platform service integrations
    proxy:
      '/prometheus/api':
        target: 'http://kube-prometheus-stack-prometheus.monitoring.svc.cluster.local:9090'
        pathRewrite:
          '^/proxy/prometheus/': '/'
        headers:
          Authorization: 'Bearer ${KUBERNETES_TOKEN}'
      
      '/grafana/api':
        target: 'http://kube-prometheus-stack-grafana.monitoring.svc.cluster.local:80'
        pathRewrite:
          '^/proxy/grafana/': '/'
        headers:
          Authorization: 'Bearer ${KUBERNETES_TOKEN}'
      
      '/elasticsearch/api':
        target: 'http://elasticsearch-master.logging.svc.cluster.local:9200'
        pathRewrite:
          '^/proxy/elasticsearch/': '/'
        headers:
          Authorization: 'Bearer ${KUBERNETES_TOKEN}'
      
      '/kibana/api':
        target: 'http://kibana-kb-http.logging.svc.cluster.local:5601'
        pathRewrite:
          '^/proxy/kibana/': '/'
        headers:
          Authorization: 'Bearer ${KUBERNETES_TOKEN}'
    
    # Integrations for external tools
    integrations:
      github:
        - host: github.com
          token: ${GITHUB_TOKEN}