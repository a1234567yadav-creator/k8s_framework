---
apiVersion: v1
kind: ConfigMap
metadata:
  name: backstage-config
  namespace: backstage
data:
  app-config.yaml: |
    app:
      title: K8s Platform Portal
      baseUrl: http://localhost:7007
    
    organization:
      name: Platform Team
    
    backend:
      baseUrl: http://localhost:7007
      listen:
        port: 7007
      csp:
        connect-src: ["'self'", 'http:', 'https:']
      cors:
        origin: http://localhost:7007
        methods: [GET, HEAD, PATCH, POST, PUT, DELETE]
        credentials: true
      database:
        client: better-sqlite3
        connection: ':memory:'
    
    integrations:
      github:
        - host: github.com
    
    # Enable proxy endpoints for Prometheus and Grafana
    proxy:
      '/prometheus/api':
        target: 'http://kube-prometheus-stack-prometheus.monitoring.svc.cluster.local:9090/api/v1/'
        changeOrigin: true
        pathRewrite:
          '^/api/proxy/prometheus/api': '/'
      
      '/grafana/api':
        target: 'http://grafana.monitoring.svc.cluster.local:80'
        changeOrigin: true
    
    # Kubernetes plugin configuration
    kubernetes:
      serviceLocatorMethod:
        type: 'multiTenant'
      clusterLocatorMethods:
        - type: 'config'
          clusters:
            - url: https://kubernetes.default.svc
              name: dev-cluster
              authProvider: 'serviceAccount'
              skipTLSVerify: false
              skipMetricsLookup: false
    
    # Catalog configuration
    catalog:
      import:
        entityFilename: catalog-info.yaml
      rules:
        - allow: [Component, System, API, Resource, Location, Domain, Group, User]
      locations:
        - type: file
          target: /app/catalog/platform-services.yaml
      providers:
        microsoftGraphOrg:
          default:
            tenantId: ${AZURE_TENANT_ID}
            clientId: ${AZURE_CLIENT_ID}
            clientSecret: ${AZURE_CLIENT_SECRET}
